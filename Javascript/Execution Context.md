# Execution Context (실행 컨텍스트)

실행 컨텍스트는 **자바스크립트의 동작 원리를 담고 있는 핵심 개념**이다. 자바스크립트는 **실행 컨텍스트가 활성화**되는 시점에 **선언된 변수를 위로 끌어올리고(hoisting)**, **외부 환경 정보를 구성**하고, **this 값을 설정**하는 등의 동작을 수행한다.

실행 컨텍스트가 언제 생성되고, 어떻게 사용되는지 알아보자.



## TL;DR

### 실행 컨텍스트

- **실행할 코드에 제공할 환경 정보들을 모아놓은 객체**

- 생성된 실행 컨텍스트는 **스택** 자료구조로 관리되어 **전체 코드의 환경과 순서를 보장**한다.

- 실행 컨텍스트 객체의 구성

  - **Lexical Environment**: 식별자와 식별자에 바인딩된 값 그리고 상위 스코프에 대한 참조를 저장
    - **Environment Record**: 현재 컨텍스트 관련된 코드의 식별자를 등록 및 등록된 식별자에 바인딩된 값을 관리하는 저장소
    - **Outer Environment Reference**: 현재 호출된 함수가 선언될 당시(상위 스코프)의 Lexical Environment  를 참조

  - **Variable Environment**: 선언 시점의 Lexical Environment의 스냅샷

  - **ThisBinding**: `this` 식별자가 바라봐야할 대상 객체



## 1. 소스코드의 평가와 실행

모든 소스코드는 실행에 앞서 평가 과정을 갖는다. 자바스크립트 엔진은 소스코드를 2개의 과정 "**1) 소스코드의 평가**"와 "**2) 소스코드의 실행**" 과정으로 나누어 처리한다.

- **평가 단계**: 실행 컨텍스트 생성, 변수 및 함수 선언문만 먼저 실행하여 생성된 식별자를 실행 컨텍스트가 관리하는 **스코프**에 등록

- **실행 단계(런타임)**: 선언문을 제외한 소스코드 순차적으로 실행. 소스코드 실행에 필요한 정보(변수, 함수의 참조)를 실행 컨텍스트가 관리하는 스코프에서 검색해서 취득

```js
// 평가 단계에서 선언한 변수에 대해 스코프에 등록한다.
let x;

// 실행 단계에서는 실행 컨텍스트가 관리하는 스코프에 해당 변수가 등록되어 있는지 확인한 후, 선언된 변수라면 값을 할당하고 할당 결과를 실행 컨텍스트에 등록하여 관리한다.
x = 1;
```



그렇다면 실행 컨텍스트는 무엇일까?



## 2. 실행 컨텍스트란?

실행 컨텍스트는 **실행할 코드에 제공할 환경 정보들을 모아놓은 객체**이다. 환경 정보들을 모아놓은 객체로 어떤 역할을 수행하고, 객체는 어떻게 구성되어 있는지 아래에서 자세히 알아보도록 하자.



## 3. 실행 컨텍스트의 역할

**실행 컨텍스트는 식별자를 등록하고 관리하는 스코프와 코드 실행 순서 관리를 구현한 내부 메커니즘으로, 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.** 즉, 실행 컨텍스트는 아래의 3가지 역할로 나눌 수 있다.

1. 선언에 의해 생성된 모든 **식별자(변수, 함수, 클래스 등)의 스코프**를 구분하여 등록하고, **상태 변화**(식별자에 바인딩된 값의 변화)를 지속적으로 관리할 수 있어야 한다.
   - 식별자와 스코프는 실행 컨텍스트의 `LexicalEnvironment`으로 관리
   - 코드 실행 순서는 실행 컨텍스트 스택(콜 스택)으로 관리

2. **스코프**는 중첩 관계에 의해 스코프 체인을 형성해야 한다. 즉, 스코프 체인을 통해 상위 스코프로 이동하며 식별자를 검색할 수 있어야 한다.

3. 현재 실행 중인 코드의 **실행 순서**를 변경(ex. 함수 호출)할 수 있어야 하며 다시 되돌아갈 수도 있어야 한다. 



### 3.1 실행 컨텍스트 스택 (Execution Context Stack, Call Stack)

소스 코드를 평가하면 함수 실행 컨텍스트를 생성한다. 이때 생성된 실행 컨텍스트는 스택 자료구조로 관리되는데, 이를 **실행 컨텍스트 스택(콜 스택)**이라고 부른다.

동작 방식은 동일한 환경에 있는 코드들을 실행할 때 필요한 환경 정보들을 모아 실행 컨텍스트를 구성, 이를 실행 컨텍스트 스택에 쌓아올렸다가, 가장 위에 쌓여있는 실행 컨텍스트와 관련 있는 코드들을 실행하여 **전체 코드의 환경과 순서를 보장**한다.



## 4. 실행 컨텍스트 객체의 구성

실행 컨텍스트 객체에 저장되는 정보에는 `VariableEnvironment`, `LexicalEnvironment`, `ThisBinding` 세 가지가 있다.

- `VariableEnvironment`

  **선언 시점**의 `LexicalEnvironment`의 스냅샷

- `LexicalEnvironment`

  현재 실행 컨텍스트 내의 **식별자들에 대한 정보 + 외부 환경 정보**. 처음에는 `VariableEnvironment` 와 같지만 변경사항이 반영됨.

- `ThisBinding`

  `this` 식별자가 바라봐야할 대상 객체



### 4.1 LexicalEnvironment

**식별자**와 **스코프**는 실행 컨텍스트의 `LexicalEnvironment`으로 관리된다.

- **식별자와 식별자에 바인딩된 값** 그리고 **상위 스코프에 대한 참조**를 저장한다.
- **객체 형태의 스코프**(전역, 함수, 블록 스코프)를 생성하고 구분하여 식별자를 등록 및 관리하는 저장소 역할을 하는 **렉시컬 스코프의 실체**이다.



#### 4.1.1 LexicalEnvironment 의 구성

- **환경 레코드 (EnvironmentRecord)**

  : 현재 컨텍스트 관련된 코드의 식별자를 등록 및 등록된 식별자에 바인딩된 값을 관리하는 저장소이다. 
  (코드가 실행되기 전에 이미 해당 환경에 속한 코드 변수명들을 모두 알고 있음 → **Hoisting**과 관련)

- **외부 렉시컬 환경에 대한 참조 (Outer Lexical Environment Reference)**

  : 현재 호출된 함수가 선언될 당시(상위 스코프)의 `LexicalEnvironment`  를 참조한다. 이를 이용해 단방향 링크드 리스트인 **스코프 체인** 구현한다.



### 4.2 요약

**실행 컨텍스트**는  `LexicalEnvironment`, `VariableEnvironment`, `thisBinding`로 구성되어 있고, `LexicalEnvironment`, `VariableEnvironment`는 실행 컨텍스트 생성 초기에 동일한 **Lexical Environment를 참조**하며 이후에 달라진다. 그리고 **Lexical Environment**는 **스코프에 포함된 식별자를 등록 및 관리하는 Environment Record와 상위 스코프를 가리키는 Outer Lexical Environment Reference로 구성**되어 있다.



## 참고자료

- [모던 자바스크립트 Deep Dive (도서)](http://www.yes24.com/Product/Goods/92742567)

- [코어 자바스크립트 (도서)](http://book.interpark.com/product/BookDisplay.do?_method=detail&sc.prdNo=316439749&gclid=CjwKCAiA1uKMBhAGEiwAxzvX94N7nFe4h54oZNvBeEN2vpWyRfgpCNAZ9ZvrvnOB-skAz2jWdvnn4xoC66kQAvD_BwE)

